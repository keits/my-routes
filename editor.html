<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¡ç‰‡å¼å°èˆªç·¨è¼¯å™¨ï¼ˆç©©å®šç‰ˆï¼‰</title>
  <style>
    body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; }
    .btn { padding: 8px 16px; margin: 10px 5px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 6px; }
    .btn:hover { background: #2980b9; }
    .card { background: white; border: 1px solid #ccc; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: move; }
    .card input, .card select { width: 100%; padding: 6px; margin-top: 6px; margin-bottom: 10px; font-size: 14px; }
    .card .delete { background: #e74c3c; }
    .card .delete:hover { background: #c0392b; }
    iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 20px; background: white; }
    #cardContainer { display: flex; flex-direction: column; gap: 10px; }
    textarea { width: 100%; height: 120px; margin-top: 10px; font-size: 14px; padding: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ å¡ç‰‡å¼å°èˆªç·¨è¼¯å™¨ï¼ˆç©©å®šç‰ˆï¼‰</h1>

  <input type="file" id="fileInput" accept=".html">
  <button class="btn" onclick="addCard()">â• æ–°å¢è·¯ç·š</button>
  <button class="btn" onclick="saveDraft()">ğŸ’¾ å„²å­˜è‰ç¨¿</button>
  <button class="btn" onclick="loadDraft()">ğŸ“‚ è¼‰å…¥è‰ç¨¿</button>
  <button class="btn" onclick="clearDraft()">ğŸ—‘ï¸ æ¸…é™¤è‰ç¨¿</button>
  <button class="btn" onclick="generate()">ğŸ’¾ ä¸‹è¼‰ index.html</button>

  <h2>ğŸš€ å¿«é€Ÿæ’å…¥å¸¸ç”¨è·¯ç·š</h2>
  <div>
    <button class="btn" onclick="insertPreset('https://maps.app.goo.gl/nmxdUYvYJYP3Hnso6','å…¬å¸ â†’ å®¶','ğŸ¢','work')">ğŸ¢ å…¬å¸ â†’ ğŸ  å®¶</button>
    <button class="btn" onclick="insertPreset('https://maps.app.goo.gl/abc123','å°åŒ—è»Šç«™ â†’ å°åŒ—101','ğŸš‰','travel')">ğŸš‰ å°åŒ—è»Šç«™ â†’ ğŸ™ï¸ å°åŒ—101</button>
    <button class="btn" onclick="insertPreset('https://maps.app.goo.gl/xyz456','åˆé¤åœ°é»','ğŸœ','food')">ğŸœ åˆé¤åœ°é»</button>
  </div>

  <h2>ğŸ“‹ æ‰¹æ¬¡è²¼ä¸Šè·¯ç·š</h2>
  <textarea id="bulkInput" placeholder="æ¯è¡Œæ ¼å¼ï¼šåç¨±,é€£çµ,emoji,åˆ†å€"></textarea>
  <button class="btn" onclick="parseBulk()">ğŸ“¥ åŒ¯å…¥è·¯ç·š</button>

  <div id="cardContainer"></div>
  <iframe id="previewFrame" sandbox="allow-scripts"></iframe>
<script>
let originalHtml = "";
let sections = [];
const sectionLabels = {
  taipei: "ğŸŒ† å°åŒ—", taichung: "ğŸï¸ å°ä¸­", kaohsiung: "ğŸŒ‡ é«˜é›„",
  work: "ğŸ’¼ å·¥ä½œ", leisure: "ğŸ‰ ä¼‘é–’", travel: "âœˆï¸ æ—…è¡Œ",
  food: "ğŸœ ç¾é£Ÿ", sports: "âš½ é‹å‹•", shopping: "ğŸ›ï¸ è³¼ç‰©",
  medical: "ğŸ¥ é†«ç™‚", education: "ğŸ« æ•™è‚²", relax: "ğŸ–ï¸ ä¼‘é¤Š",
  social: "ğŸ§‘â€ğŸ¤â€ğŸ§‘ èšæœƒ", frequent: "ğŸ§­ å¸¸ç”¨", todo: "ğŸ§¹ ä»£è¾¦", business: "ğŸ§³ å‡ºå·®"
};

document.getElementById('fileInput').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(event) {
    originalHtml = event.target.result;
    const doc = new DOMParser().parseFromString(originalHtml, "text/html");
    sections = Array.from(doc.querySelectorAll("div.city[id]")).map(div => div.id);
    if (sections.length === 0) {
      sections = ["work", "food", "travel"];
      alert("âš ï¸ index.html æœªåµæ¸¬åˆ°åˆ†å€ï¼Œå·²è¼‰å…¥é è¨­åˆ†å€");
    } else {
      alert("âœ… index.html å·²è®€å–å®Œæˆï¼");
    }
    updatePreview();
  };
  reader.readAsText(e.target.files[0]);
});

function addCard(data = {}) {
  const container = document.getElementById("cardContainer");
  const card = document.createElement("div");
  card.className = "card";
  card.draggable = true;

  card.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", [...container.children].indexOf(card));
    card.classList.add("dragging");
  });
  card.addEventListener("dragend", () => card.classList.remove("dragging"));

  let options = sections.map(s => {
    const label = sectionLabels[s] || s;
    return `<option value="${s}" ${data.section === s ? "selected" : ""}>${label}</option>`;
  }).join("");

  card.innerHTML = `
    <input type="text" placeholder="Google Maps é€£çµ" value="${data.url || ""}" oninput="updatePreview()">
    <input type="text" placeholder="åç¨±ï¼ˆä¾‹å¦‚ï¼šå®¶ â†’ å…¬å¸ï¼‰" value="${data.name || ""}" oninput="autoEmoji(this); updatePreview()">
    <input type="text" placeholder="Emojiï¼ˆä¾‹å¦‚ ğŸš—ï¼‰" value="${data.emoji || ""}" oninput="updatePreview()">
    <select onchange="updatePreview()">${options}</select>
    <button class="btn delete" onclick="this.parentElement.remove(); updatePreview()">âŒ åˆªé™¤</button>
  `;
  container.appendChild(card);
}

function insertPreset(url, name, emoji, section) {
  addCard({ url, name, emoji, section });
  updatePreview();
}

function autoEmoji(nameInput) {
  const emojiInput = nameInput.nextElementSibling;
  if (emojiInput.value.trim()) return;
  const name = nameInput.value;
  const map = {
    "å¤œå¸‚": "ğŸ¢", "ç¾è¡“é¤¨": "ğŸ–¼ï¸", "è»Šç«™": "ğŸš‰", "æ©Ÿå ´": "âœˆï¸", "å…¬åœ’": "ğŸŒ³",
    "ç™¾è²¨": "ğŸ›ï¸", "å­¸æ ¡": "ğŸ«", "é†«é™¢": "ğŸ¥", "æµ·é‚Š": "ğŸ–ï¸", "é£¯åº—": "ğŸ¨",
    "å…¬å¸": "ğŸ¢", "å®¶": "ğŸ ", "é‹å‹•": "âš½", "æ—…è¡Œ": "âœˆï¸", "èšæœƒ": "ğŸ§‘â€ğŸ¤â€ğŸ§‘"
  };
  for (const key in map) {
    if (name.includes(key)) {
      emojiInput.value = map[key];
      break;
    }
  }
}

function parseBulk() {
  const lines = document.getElementById("bulkInput").value.trim().split("\n");
  lines.forEach(line => {
    const [name, url, emoji, section] = line.split(",");
    if (name && url && section) {
      addCard({ name: name.trim(), url: url.trim(), emoji: emoji?.trim() || "", section: section.trim() });
    }
  });
  updatePreview();
}

function saveDraft() {
  const cards = document.querySelectorAll(".card");
  let draft = [];
  cards.forEach(card => {
    const inputs = card.querySelectorAll("input, select");
    draft.push({
      url: inputs[0].value,
      name: inputs[1].value,
      emoji: inputs[2].value,
      section: inputs[3].value
    });
  });
  localStorage.setItem("cardDraft", JSON.stringify(draft));
  alert("âœ… è‰ç¨¿å·²å„²å­˜ï¼");
}

function loadDraft() {
  const draft = JSON.parse(localStorage.getItem("cardDraft") || "[]");
  if (draft.length === 0) {
    alert("âš ï¸ æ²’æœ‰å„²å­˜çš„è‰ç¨¿ï¼");
    return;
  }
  document.getElementById("cardContainer").innerHTML = "";
  draft.forEach(data => addCard(data));
  updatePreview();
}

function clearDraft() {
  localStorage.removeItem("cardDraft");
  alert("ğŸ—‘ï¸ è‰ç¨¿å·²æ¸…é™¤ï¼");
}

function buildUpdatedHtml() {
  let sectionButtons = {};
  sections.forEach(s => sectionButtons[s] = "");
  const cards = document.querySelectorAll(".card");

  cards.forEach(card => {
    const inputs = card.querySelectorAll("input, select");
    const url = inputs[0].value.trim();
    const name = inputs[1].value.trim();
    const emoji = inputs[2].value.trim() || "ğŸ“";
    const section = inputs[3].value;
    if (url && name && section) {
      const button = `<a class="building" href="${url}" target="_blank">${emoji} ${name}</a>\n`;
      sectionButtons[section] += button;
    }
  });

  let updatedHtml = originalHtml || generateBlankHtml();
  for (const sec of sections) {
    const regex = new RegExp(`(<div class="city" id="${sec}">)([\\s\\S]*?)(</div>)`, "i");
    updatedHtml = updatedHtml.replace(regex, `$1\n${sectionButtons[sec]}$3`);
  }
  return updatedHtml;
}

function generateBlankHtml() {
  return `
    <html><head><title>é è¦½</title></head><body>
    ${sections.map(s => `<h2>${sectionLabels[s] || s}</h2><div class="city" id="${s}"></div>`).join("\n")}
    </body></html>
  `;
}

function updatePreview() {
  const html = buildUpdatedHtml();
  document.getElementById("previewFrame").srcdoc = html;
}

function generate() {
  const html = buildUpdatedHtml();
  const blob = new Blob([html], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "index.html";
  a.click();
}
</script>
</body>
</html>
